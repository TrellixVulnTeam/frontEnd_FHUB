## 1.ios网络七层模型，http、tcp在哪一层?

### 1.1 ios网络七层模型：物理层，链路层，网络层，传输层，会话层，表示层，应用层

- `发送方`从最高层开始，`从上到下按顺序传输`数据，`每一层接收到由上层处理的数据`时，`添加该层的首部并可能会对数据进行处理`
- `接收端`则将顺序反过来，`从首层开始`，`将数据的内容与该层对应的首部拆开，传给上一层`。

#### 1.1.1 应用层

为应用程序提供服务，**`[HTTP]`**在这一层。把`浏览器看作一个应用`，当用户发起请求时，通过 `HTTP协议`获得数据以供浏览器使用，这就是应用层的用途。而请求时发生错误，`对错误进行处理`，也是应用层需要负责的。

#### 1.1.2 表示层

负责`数据格式的转换`。常见的协议有 `ASCII`、`[SSL/TLS]` 等

浏览器请求回一堆数据，是`解析成文本还是图片`，就由表示层决定

数据的`压缩、加密、打包`等功能也都在这层完成



#### 1.1.3 会话层

负责`建立和断开通信连接`.常见的协议有 `ADSP`、`RPC` 等。



#### 1.1.4 传输层

管理`两个节点之间的数据传输`，会`指定通信端口`，让服务器可以通过端口知道用什么协议。此层有两个具有代表性的协议： `TCP` 与 `UDP`。

**`TCP`** 协议提供`可靠的通信传输`，`确认目标能通信的情况下才会传输数据`（因此需要`三次握手`），`传输过程如果丢了数据，也会重发`。而

 `UDP` 协议则不然，`不会确认目标能否通信`，`只会根据协议发到对方地址的端口`。`至于对方收不收到，丢不丢包，一概不管`。



#### 1.1.5 网络层

网络层负责`将数据传输到目标地址`，进行`寻址和路由选择`。主要由 `IP`、`ICMP` 两个协议组成。

网络层`将数据从发送端的主机发送到接收端的主机`，两台`主机间可能会存在很多数据链路`，但网络层就是`负责找出一条相对顺畅的通路`将数据传递过去。传输的地址使用的是IP地址



#### 1.1.6 数据链路层

负责`物理层面上互连的节点之间的通信传输`。`只负责将数据运送给物理相连的两端`，并不负责直接发送到最终地址。`将0、1序列划分为具有意义的数据帧`传送给对端（数据帧的生成与接收）



#### 1.1.7 物理层

`将数据的0、1转换成电信号或者光信号`。`通过光纤、双绞线甚至是无限电波等介质传输到指定的地址`。集线器、中继器、调制解调器等，也属于物理层的传输介质



## 2.介绍应用层协议：DNS，http

### 2.1 DNS

DNS是域名解析协议，我们一般向服务器发送请求，因为服务器其实本质也是一台计算机，我们是需要拿到它的IP地址，然后发送请求。但是一般的IP地址都是二进制，并不方便记忆。所以就让IP地址映射成了现在的域名，进行访问的时候，将域名解析为IP地址即可

DNS就是提供域名到IP地址的解析服务

1. 首先搜索**`浏览器的 DNS 缓存`**，缓存中维护一张域名与 IP 地址的对应表；
2. 若没有命中，则继续搜索**`操作系统的 DNS 缓存`**；
3. 若仍然没有命中，则操作系统将域名发送至**`本地域名服务器`**，本地域名服务器`查询自己的 DNS 缓存`，查找成功则返回结果（注意：主机和本地域名服务器之间的查询方式是**`递归查询`**）；
4. 若本地域名服务器的 DNS 缓存没有命中，则本地域名服务器`向上级域名服务器`进行查询，通过以下方式进行**迭代查询**
   - 首先本地域名服务器向**`根域名服务器`**发起请求，根域名服务器`会返回顶级域名服务器的地址`，给给本地域名服务器指明一条道路
   - 然后本地域名服务器向**`顶级域名服务器`**发起请求，获取**`权限域名服务器`**的地址
   - 本地域名服务器根据**`权限域名服务器`**的地址向其发起请求，最终得到该域名对应的 IP 地址
5. 本地域名服务器将得到的 IP 地址`返回给操作系统`，同时`自己将 IP 地址缓存`起来
6. 操作系统将 IP 地址`返回给浏览器`，同时`自己也将 IP 地址缓存`起来
7. 至此，`浏览器`就得到了域名对应的 IP 地址，`并将 IP 地址缓存`起来



### 2.2 http

http是对客户端和服务器之间`数据传输的格式规范`，是“超文本传输协议”。默认端口是80，是无连接无状态的协议。



## 3. TCP为什么是三次握手？如果是两次有什么问题？

信道不可靠, 但是通信双发需要就某个问题达成一致. 而要解决这个问题, 三次通信是理论上的最小值. 所以三次握手不是TCP本身的要求, 而是为了满足"`在不可靠信道上可靠地传输信息`"这一需求所导致的.

`两次握手`可能会导致`当已失效的连接请求报文段`被传送到了服务器时，服务器收到报文时，`误认为是客户端发出的一个新的连接请求`。于是就向客户端发出确认报文段，同意建立连接。但其实客户端现在并没有发出建立连接的请求，而`服务端因为却以为新的运输连接已经建立，并一直等待客户端发来数据，浪费掉了资源`。而如果是`三次握手`，服务端收不到确认，就知道客户端并没有建立连接，就可以断开



## 4. TCP如何保证可靠性？

TCP 使用`校验和`，`确认`和`重传机制`来保证可靠传输

- **`校验和`**：发送的`数据段`都当做一个`16位的整数`。将这些整数`加起来`。并且前面的`进位不能丢弃`，`补在后面`，最后`取反`。发送方发送数据前进行校验和计算，接收方接到数据后，也进行校验和计算，然后进行对比，两者不一致，那么数据传输一定有误；两者一致也不一定传输成功
- **`确认应答与序列号`**：TCP传输时将`每个字节的数据都进行了编号`，这就是`序列号`。每次`接收方`收到数据后，都会对`进行确认应答`。发送ACK报文告诉发送方，`接收到了哪些数据，下一次的数据从哪里发`。有了序列号能够将接收到的数据`根据序列号排序`，并且去`掉重复序列号`的数据
- **`超时重传`**：由于确认应答与序列号机制，也就是说`发送方发送一部分数据后`，都会`等待接收方发送的ACK报文`，并解析ACK报文，`判断数据是否传输成功`。如果发送方在发送完数据后`等待一个时间`，`没有接收到ACK报文`，那么对刚才发送的数据进行`重新发送`。因为发送方没收到ACK报文有两种情况，第一发送方发送的数据中途丢失，第二接收方发送的ACK报文丢失，如果是第一种情况，接收方收到重传报文后，会发送ACK报文，如果是第二种情况，接收方根据序列号发现数据已经接受过了，就将本次收到的数据丢弃，发送ACK报文
- 三次握手、四次挥手
- **`流量控制`**：如果`发送端的速度太快`，会导致接收方还未来得及处理完数据，而`接收缓冲区很快的填充满`了，进而会导致后续发送的数据丢包。而TCP可以`根据接收端的处理能力调整发送端的速度`。在`TCP协议的报头信息`当中，有一个16位字段的窗口大小，内容实际上是`接收端接收数据缓冲区的剩余大小`。`接收端`会在确认应答`发送ACK报文`时，`将自己的接收数据缓冲区剩余大小填入`。`发送方`就可以根据该值`调整自己的发送速度`，如果剩余大小为0，发送端会`停止发送数据`，并定期向接收端发送窗口`大小侦测报文`，让接收端把窗口大小发送给它。
- **`拥塞控制：`**如果发送端在`一开始就发送大量数据`，网络`可能在开始的时候比较拥堵`，会产生`大量的数据超时重传`或者`丢包`。TCP引入了慢启动的机制，`在开始发送数据时`，先`发送少量的数据探路`。`探清当前的网络状态如何，再决定多大的速度进行传输`。有一个`拥塞窗口`的概念，发送刚开始`定义拥塞窗口为 1`，每次`收到ACK应答`，`拥塞窗口加 1`。在发送数据之前，首先`将拥塞窗口与接收端反馈的窗口大小`比对，`取较小的值`作为实际发送的窗口。为了控制拥塞窗口的增长，会设置一个阈值，当拥塞窗口大小超过阈值时，会从原来的指数增长变为线性增长。一旦造成网络拥塞，发生超时重传时，慢启动的`阈值会将为当前造成网络拥塞的窗口大小的一半`，同时拥塞窗口大小变为1



## 5. TCP丢包了如何处理

在 TCP 传输的过程中，如果发生了丢包，即`接收端发现数据段不是按序到达的时候`，接收端的处理是`重复发送之前的 ACK`。比如第 5 个包丢了，即使第 6、7 个包到达的接收端，接收端也一律返回第 4 个包的 ACK。当`发送端收到 3 个重复的 ACK 时，意识到丢包了，于是马上进行重传`。

在这个ACK报文首部的可选项中，会加上`SACK`这个属性，通过`left edge`和`right edge`告知发送端已经收到了哪些区间的数据报。因此，即使第 5 个包丢包了，当收到第 6、7 个包之后，接收端依然会告诉发送端，这两个包到了。



## 6. TCP/IP四层模型

应用层：会话管理、数据加密/解密、为应用程序提供服务等

传输层： 建立、维护、管理网络连接中两台计算机端到端的数据传输

网络层：规定了通过怎样的路径到达对方计算机，并把数据包传送给对方（IP选址、路由选择）

数据链路层：处理连接网络的硬件部分。



**`改动自由`**：比如， 如果互联网只由一个协议统筹， 某个地方需要改变设计时， 就必须把所有部分整体替换掉。 而分层之后只需把变动的层替换掉即可。 把各层之间的接口部分规划好之后， 每个层次内部的设计就能够自由改动了。
设计简单：值得一提的是， 层次化之后， 设计也变得相对简单了。 处于应用层上的应用可以只考虑分派给自己的任务， 而不需要弄清对方在地球上哪个地方、 对方的传输路线是怎样的、 是否能确保传输送达等问题。



## 7. DNS使用什么协议传输？为什么

DNS在区域传送时使用TCP协议，域名解析时使用UDP协议

- DNS规范中规定了2种类型的DNS服务器，一个叫主[DNS服务器](https://link.segmentfault.com/?enc=cx7cghT%2BhGXCP8okjG6qLQ%3D%3D.95Ljgf3QNRdQdFoDC%2FPAy0Py3NhsRgzftaV6nIgZf%2BA%3D)，一个叫`辅助DNS服务器`。主DNS服务器从自己本机的数据文件中读取该区的DNS数据信息，而辅助DNS服务器则从区的主DNS服务器中读取该区的DNS数据信息。`辅域名服务器会定时（一般时3小时）向主域名服务器进行查询以便了解数据是否有变动`。如有变动，则会执行一次`区域传送`，进行数据同步。数据量通常比较大，UDP报文的最大长度为512字节，而TCP协议允许报文超过512字节，所以用TCP传输
- 而`域名解析时的数据都不超过512字节`，用UDP传输即可。不用经过TCP三次握手，这样DNS服务器负载更低，响应更快。



## 8. tcp 复用是怎么实现的

- `客户端`（如：ClientA）与`负载均衡设备`之间`进行三次握手并发送HTTP请求`。负载均衡设备收到请求后，会`检测服务器是否存在空闲的长连接`，如果不存在，服务器将建立一个新连接。当HTTP请求响应完成后，`客户端则与负载均衡设备协商关闭连接`，而`负载均衡则保持与服务器之间的这个连接`。
- 当有`其它客户端（如：ClientB）需要发送HTTP请求时`，`负载均衡设备`会直接`向与服务器之间保持的这个空闲连接发送HTTP请求`，避免了由于新建TCP连接造成的延时和服务器资源耗费。
