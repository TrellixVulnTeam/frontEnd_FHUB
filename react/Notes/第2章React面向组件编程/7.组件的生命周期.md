# 组件的生命周期

## 1.引入组件的生命周期

实现效果：加油呀逐渐透明至消失，再消失后有立马变成纯黑。点击按钮，整个组件消失

![image-20220128102003286](C:\Users\zayn\AppData\Roaming\Typora\typora-user-images\image-20220128102003286.png)

为了实现透明效果，需要给加油呀所在的h1盒子的样式绑定**`opacity`**属性

透明度逐渐减少，肯定是要不断改变样式里的opacity属性，状态中的数据驱动着页面的显示。所以在this.state里设立一个opacity并将样式里的透明度值设置为从this.opacity里拿出的数据

![image-20220128105148354](C:\Users\zayn\AppData\Roaming\Typora\typora-user-images\image-20220128105148354.png)

为了实现动态效果，调用**`定时器`**，将this.state里的opacity属性逐渐减小，直至为0后，又设置为1。因为状态里的数据发生了变化 ，React会不断调用render函数重新渲染页面，实现逐渐透明的效果。

但如果将定时器放在render()函数里，定时器一旦改变了 this.state.opacity，React就会重新调用render()函数渲染页面，这样就会又生成一个定时器，陷入死循环

![image-20220128105337719](C:\Users\zayn\AppData\Roaming\Typora\typora-user-images\image-20220128105337719.png)

我们想**`在一个只会调用一次的函数里放置定时器`**，这是我们想到将其放到**`构造器函数`**里

![image-20220128105614231](C:\Users\zayn\AppData\Roaming\Typora\typora-user-images\image-20220128105614231.png)

将其放到构造器函数有一点不合理，引入生命周期函数，我们将其放到React自动生成的**`componentDidMount()`**表示**`组件挂载完毕函数`**里，虽然是**`React自动生成且调用`**的，但里面是空的，我们将定时器放入

![image-20220128105839118](C:\Users\zayn\AppData\Roaming\Typora\typora-user-images\image-20220128105839118.png)

接下来实现点击后消除组件功能。给按钮绑定回调函数，在回调函数里实现清除定时器和卸载组件

- **`清除定时器需要让回调函数知道是哪个定时器`**，如果用let timer = XX这只是在挂在完毕函数作用域里，回调函数用不上。我们考虑到componentDidMount()这个函数是React通过实例自动调用的，里面的this指向实例。同时回调函数用到了赋值+箭头函数，里面的this也指向实例，所以我们**`在componentDidMount()这个函数将定时器绑定在实例属性上`**，然后在回调函数里通过实例删除
- **`卸载组件这个React封装好的函数，参数是组件挂载的真实节点`**。

![image-20220128112635840](C:\Users\zayn\AppData\Roaming\Typora\typora-user-images\image-20220128112635840.png)

我们将情况扩展，如果只想在回调函数里实现卸载组件功能，那么**`清除定时器我们可以放在componentWillUnmount()函数里`**。**`这个函数会在组件真正被卸载前调用`**。

![image-20220128113503101](C:\Users\zayn\AppData\Roaming\Typora\typora-user-images\image-20220128113503101.png)

![image-20220128113434739](C:\Users\zayn\AppData\Roaming\Typora\typora-user-images\image-20220128113434739.png)

### 1.1 疑惑

在组件渲染到页面后，获取组件内标签的属性，改变其属性值，仍然能动态实现效果

**`无需放在state里`**。但用到了ref，能避免不用就不用

![image-20220128110342449](C:\Users\zayn\AppData\Roaming\Typora\typora-user-images\image-20220128110342449.png)

## 2.组件的生命周期函数/钩子理解

render、componentWillxxxx、componentDidxxx等，都被称为React声明周期函数

**`组件虽然可能会被不断更新，但是挂载在页面只会挂一次`**

1. 组件从创建到死亡它会经历一些特定的阶段。
2. React组件中包含一系列勾子函数(生命周期回调函数), **`会在特定的时刻由React调用`**。
3. 我们在定义组件时，**`会在特定的生命周期回调函数中，做特定的工作`**。

## 3.生命周期流程（旧）

![image-20220128140040051](C:\Users\zayn\AppData\Roaming\Typora\typora-user-images\image-20220128140040051.png)

生命周期的三个阶段(旧)：

### 3.1初始化阶段

由ReactDOM.render()触发---初次渲染。第一次将组件渲染到页面的时候，React会自动按顺序调用以下函数

1. constructor()            构造器
2.  componentWillMount()       组件将要挂载，挂载前的**`准备工作`**
3.  render()	                             挂载组件
4.  componentDidMount()        组件挂载完毕，**`收尾工作`**

![image-20220128142239642](C:\Users\zayn\AppData\Roaming\Typora\typora-user-images\image-20220128142239642.png)

![image-20220128142251655](C:\Users\zayn\AppData\Roaming\Typora\typora-user-images\image-20220128142251655.png)

### 3.2 更新阶段

由组件内部**`this.setSate()`**或**`父组件重新render`**触发

![image-20220128142324556](C:\Users\zayn\AppData\Roaming\Typora\typora-user-images\image-20220128142324556.png)

1. shouldComponentUpdate()         **`是否允许组件更新`**，true允许更新，false不允许更新

   - 如果不允许更新（底层默认是true，自己可修改成false）， React不会执行下列函数

     ![image-20220128143118204](C:\Users\zayn\AppData\Roaming\Typora\typora-user-images\image-20220128143118204.png)

     - 实际上即使不允许组件更新，**`React底层是将搜集了想要更新的数据，只是没设置到this.state里以及渲染`**。**`一旦允许更新或者强制更新，this.state会被马上更新，页面也会重新渲染`**

       ![image-20220128153505998](C:\Users\zayn\AppData\Roaming\Typora\typora-user-images\image-20220128153505998.png)

2. componentWillUpdate()               组件将要更新，**`更新前的准备工作`**

3.  render()                                          组件更新

4. componentDidUpdate()               组件完成更新，**`更新完毕后的收尾工作`**

![image-20220128143720995](C:\Users\zayn\AppData\Roaming\Typora\typora-user-images\image-20220128143720995.png)

由**`this.forceUpdate()`**触发的强制更新即使不允许组件更新，它也会让页面更新

1. componentWillUpdate()               组件将要更新，**`更新前的准备工作`**
2.  render()                                          组件更新
3. componentDidUpdate()               组件完成更新，**`更新完毕后的收尾工作`**

![image-20220128153416893](C:\Users\zayn\AppData\Roaming\Typora\typora-user-images\image-20220128153416893.png)

强调一下**`生命周期函数`**，是在**`初始化挂载组件或者更新组件`**时，React一定会调用的函数，不管在不在这些函数内部写代码，**`React都会通过实例自动调用`**。而类似于**`this.setState()和this.forceUpdate()`**是由我们**`程序员自己写的`**，用于**`告诉React在这个地方想要调用这两个函数`**，所以我们**`需要this来告诉React这两个函数在哪里`**。而这两个方法都是React提供的，在React.Component原型上，通过原型链找到

